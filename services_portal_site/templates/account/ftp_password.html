{% extends 'layout_sidebar.html' %}

{% block head_js_extra %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/5.5.2/bootbox.min.js"></script>
{{ block.super }}{% endblock %}

{% block breadcrumbs %}
<ol class="breadcrumb bg-primary">
    <li class="breadcrumb-item">
        <a class="breadcrumb-link text-light" style="text-decoration: none;" href="{% url 'jasmin_services:my_services'%}">
            CEDA Services
        </a>
    </li>
    <li class="breadcrumb-item active">FTP Password Generator</li>
</ol>
{% endblock %}

{% block content %}
<div class="banner banner-warning">
    <p>We are changing the way FTP accounts work, see <a href="https://help.ceda.ac.uk/article/39-ceda-account" class="text-primary">here</a> for more information. </p>
</div>
<div class="col-sm-12 col-md-12">
    <h3>CEDA FTP</h3>
    <div class="col-sm-12 col-md-12">
        <p>
            FTP is a useful tool for bulk downloading data for which many clients can be found on the internet. As this is not a secure protocol users are required to use a specific password for FTP transfers which can be generated using the button below. For more details on FTP usage please see our help page here.
        </p>

{% if request.user.has_ftp_password %}
    <p>
        <b>There is already a FTP password associated with this account. Are you sure you wish to create another?</b>
    </p>
{% endif %}
    </div>
</div>
<div class="col-sm-12 col-md-12">
    <form method="POST" action="" class="form-horizontal"  id="create_password_form">
        {% csrf_token %}
        <div class="form-group" >
{% if request.user.has_ftp_password %}
            <button type="submit" class="float-right btn btn-md btn-primary">Create new password</button>
{% else %}
            <button type="submit" class="float-right btn btn-md btn-primary">Create password</button>
{% endif %}
        </div>
    </form>
</div>

{% if password %}
    {# The HTML inside here is what will be rendered in the key created dialog #}
    <script id="password-creation-content" type="text/template">
        <div class="banner banner-info">
            <p><strong>Password: </strong><code>{{ password }}</code></p>
            <p><strong class="text-danger">WARNING:</strong> Make sure you copy this <code>password</code> and store it somewhere safe - you will not be able to see it again after you press the <code>OK</code> button!</p>
        </div>
    </script>

    <script>
        // If a password has been created, pop a dialog to display it
        bootbox.dialog({
            closeButton : false,
            size : 'large',
            title : 'Successfully created FTP password',
            message : $('#password-creation-content').html(),
            buttons : {
                "OK" : {
                    label: "OK - I've copied the password",
                    className: 'btn-primary',
                    callback: function(){ window.location.replace(window.location.href);}
                }
            },
        });

    </script>
{% endif %}

<script id="password-confirmation-content" type="text/template">
    <div class="banner banner-info">
        <p><strong class="text-danger">WARNING:</strong> This will override any existing ftp passwords.</p>
    </div>
</script>

<script>
    // Confirmations they want to generate a new password
    var $password_form = $('#create_password_form');
    $password_form.submit(function(e) {
        if( $password_form.data('confirmed') ) {
            return true;
        }
        // pop a dialog with the confirmation
        bootbox.dialog({
            closeButton : false,
            size : 'large',
            title : 'Are you sure?',
            message : $('#password-confirmation-content').html(),
            buttons : {
                'cancel' : {
                    label: 'Cancel',
                    className: 'btn-default'
                },
                'agree' : {
                    label: 'Confirm',
                    className: 'btn-primary',
                    callback: function() {
                        $password_form.data('confirmed', true);
                        $password_form.submit();
                    }
                }
            }
        });
        e.preventDefault();
    })
</script>

{% endblock %}
